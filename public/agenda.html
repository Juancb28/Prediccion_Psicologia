<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - MindCare</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>

<div class="container">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo-container">
            <div class="logo-icon">ğŸ§ </div>
            <h2 class="logo">MindCare</h2>
            <p class="logo-subtitle">Sistema ClÃ­nico</p>
        </div>
        <ul class="menu-list">
            <li class="menu-item">
                <a href="/dashboard" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;">
                    <span class="menu-icon">ğŸ“Š</span>
                    <span class="menu-text">Panel</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/pacientes" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;">
                    <span class="menu-icon">ğŸ‘¥</span>
                    <span class="menu-text">Pacientes</span>
                </a>
            </li>
            <li class="menu-item active">
                <a href="/agenda" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;">
                    <span class="menu-icon">ğŸ“…</span>
                    <span class="menu-text">Agenda</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="/sesiones" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;">
                    <span class="menu-icon">ğŸ’¬</span>
                    <span class="menu-text">Sesiones</span>
                </a>
            </li>
        </ul>
        <div class="sidebar-footer" onclick="window.location.href='/perfil'" style="cursor: pointer;">
            <div class="user-info">
                <div class="user-avatar">ğŸ‘¨â€âš•ï¸</div>
                <div class="user-details">
                    <div class="user-name">Dr. PsicÃ³logo</div>
                    <div class="user-status">En lÃ­nea</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="content" id="mainContent">
        <h1>Agenda</h1>
        <div class="agenda-controls">
            <button class="view-btn" onclick="window.location.href='/agenda'">ğŸ“‹ Lista</button>
            <button class="view-btn create-btn" onclick="showCreateCitaModal()">â• Crear cita</button>
        </div>
        <div class="card">
            <div id="appointmentsList">
                <!-- Las citas se cargarÃ¡n aquÃ­ -->
            </div>
        </div>
    </main>

</div>

<!-- Modal Container -->
<div id="modalRoot"></div>

<script>
// Agenda: conectar con /api/pacientes y /api/citas
(function() {
    'use strict';

    let appointmentsCache = [];
    let patientsCache = [];

    async function fetchPatients() {
        try {
            const res = await fetch('/api/pacientes');
            if (res.ok) {
                const j = await res.json();
                patientsCache = (j && j.pacientes) || [];
                return patientsCache;
            }
        } catch (e) { /* ignore */ }
        // fallback to localStorage/data.json
        try { patientsCache = JSON.parse(localStorage.getItem('pp_patients') || '[]'); } catch (e) { patientsCache = []; }
        return patientsCache;
    }

    async function fetchAppointments() {
        try {
            const res = await fetch('/api/citas');
            if (res.ok) {
                const j = await res.json();
                appointmentsCache = (j && j.citas) || [];
                return appointmentsCache;
            }
        } catch (e) { /* ignore */ }
        try { appointmentsCache = JSON.parse(localStorage.getItem('pp_agenda') || '[]'); } catch (e) { appointmentsCache = []; }
        return appointmentsCache;
    }

    function saveAppointmentsLocal(appointments) {
        localStorage.setItem('pp_agenda', JSON.stringify(appointments));
    }

    function formatStatusClass(estado) {
        if (!estado) return 'pending';
        const s = String(estado).toLowerCase();
        if (s.includes('confirm')) return 'confirmed';
        if (s.includes('pend')) return 'pending';
        if (s.includes('finaliz')) return 'finished';
        return 'cancelled';
    }

    async function renderAppointments() {
        await fetchPatients();
        await fetchAppointments();

        const listContainer = document.getElementById('appointmentsList');
        const appointments = appointmentsCache || [];
        const patients = patientsCache || [];

        if (!appointments.length) {
            listContainer.innerHTML = '<div class="empty-state">ğŸ“­ No hay citas programadas</div>';
            return;
        }

        listContainer.innerHTML = appointments.map((apt, index) => {
            const patient = patients.find(p => String(p.id) === String(apt.paciente_id || apt.pacienteId || apt.pacienteId));
            const statusClass = formatStatusClass(apt.estado || apt.status);
            const patientName = patient ? patient.nombre : (apt.paciente_name || 'â€”');

            return `
                <div class="appointment-item ${statusClass}">
                    <div onclick="window.__agenda.editAppointmentByIndex(${index})" style="flex: 1; cursor: pointer;">
                        <div class="appointment-header">
                            <div class="appointment-datetime">
                                <span class="appointment-icon">ğŸ•</span>
                                <span class="appointment-date">${apt.fecha || apt.date || ''}</span>
                                <span class="appointment-time">${apt.hora || apt.time || ''}</span>
                            </div>
                            <span class="appointment-status status-${statusClass}">${apt.estado || apt.status || ''}</span>
                        </div>
                        <div class="appointment-patient">
                            <span class="patient-icon">ğŸ‘¤</span>
                            <span class="patient-name">${patientName}</span>
                        </div>
                    </div>
                    <button class="delete-btn-small" onclick="event.stopPropagation(); window.__agenda.deleteCitaByIndex(${index})" title="Eliminar cita">ğŸ—‘ï¸</button>
                </div>
            `;
        }).join('');
    }

    // Expose an object for modal callbacks
    window.__agenda = {
        editAppointmentByIndex: async function(index) {
            const apt = appointmentsCache[index];
            if (!apt) { alert('âŒ No se encontrÃ³ la cita'); return; }
            const patients = patientsCache;

            const patient = patients.find(p => String(p.id) === String(apt.paciente_id || apt.pacienteId)) || null;

            const modalHTML = `
                <div class="modal-backdrop" onclick="event.target === this && window.__agenda.closeModal()">
                    <div class="modal">
                        <div class="modern-modal-header"><h3 class="modal-title">Editar cita</h3></div>
                        <div class="modern-modal-body">
                            <form id="editCitaForm">
                                <div class="modern-form-group">
                                    <label class="modern-label"><span class="label-icon">ğŸ‘¤</span><span>Paciente</span></label>
                                    <select name="paciente_id" class="modern-select" required>
                                        ${patients.map(p => `<option value="${p.id}" ${patient && String(p.id)===String(patient.id) ? 'selected' : ''}>${p.nombre}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="modern-form-group">
                                    <label class="modern-label"><span class="label-icon">ğŸ“…</span><span>Fecha</span></label>
                                    <input name="fecha" type="date" class="modern-input" value="${apt.fecha || apt.date || ''}" required>
                                </div>
                                <div class="modern-form-group">
                                    <label class="modern-label"><span class="label-icon">ğŸ•</span><span>Hora</span></label>
                                    <input name="hora" type="time" class="modern-input" value="${apt.hora || apt.time || ''}" required>
                                </div>
                                <div class="modern-form-group">
                                    <label class="modern-label"><span class="label-icon">ğŸ“Š</span><span>Estado</span></label>
                                    <select name="estado" class="modern-select">
                                        <option ${apt.estado === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                        <option ${apt.estado === 'Confirmada' ? 'selected' : ''}>Confirmada</option>
                                        <option ${apt.estado === 'Finalizada' ? 'selected' : ''}>Finalizada</option>
                                        <option ${apt.estado === 'Anulada' ? 'selected' : ''}>Anulada</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modern-modal-footer">
                            <button class="modern-btn delete-btn" onclick="window.__agenda.confirmDeleteByIndex(${index})" style="margin-right: auto;">ğŸ—‘ï¸ Eliminar</button>
                            <button class="modern-btn cancel-btn" onclick="window.__agenda.closeModal()">Cancelar</button>
                            <button class="modern-btn save-btn" onclick="window.__agenda.saveEditedCita(${index})">ğŸ’¾ Guardar</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalRoot').innerHTML = modalHTML;
        },

        deleteCitaByIndex: async function(index) {
            const apt = appointmentsCache[index];
            if (!apt) { alert('âŒ No se encontrÃ³ la cita'); return; }
            const patient = patientsCache.find(p => String(p.id) === String(apt.paciente_id || apt.pacienteId)) || null;
            const patientName = patient ? patient.nombre : 'Desconocido';
            if (!confirm(`Â¿Eliminar cita?\nPaciente: ${patientName}\nFecha: ${apt.fecha || apt.date}\nHora: ${apt.hora || apt.time}`)) return;

            if (apt.id) {
                try {
                    const res = await fetch(`/api/citas/${apt.id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('delete_failed');
                } catch (e) { alert('Error eliminando cita en servidor'); }
            } else {
                // fallback: remove from localStorage
                appointmentsCache.splice(index,1);
                saveAppointmentsLocal(appointmentsCache);
            }
            window.__agenda.closeModal();
            await renderAppointments();
            alert('âœ… Cita eliminada correctamente');
        },

        confirmDeleteByIndex: function(index) { window.__agenda.deleteCitaByIndex(index); },

        saveEditedCita: async function(index) {
            const form = document.getElementById('editCitaForm');
            if (!form.checkValidity()) { form.reportValidity(); return; }
            const fd = new FormData(form);
            const payload = { paciente_id: fd.get('paciente_id'), fecha: fd.get('fecha'), hora: fd.get('hora'), estado: fd.get('estado') };
            const apt = appointmentsCache[index];

            try {
                // If appointment exists on server, delete it and recreate (simple update)
                if (apt && apt.id) {
                    await fetch(`/api/citas/${apt.id}`, { method: 'DELETE' });
                }
                const res = await fetch('/api/citas', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error('create_failed');
            } catch (e) { alert('Error guardando cita en servidor'); }

            window.__agenda.closeModal();
            await renderAppointments();
            alert('âœ… Cita actualizada correctamente');
        },

        closeModal: function() { document.getElementById('modalRoot').innerHTML = ''; }
    };

    // Mostrar modal de nueva cita (usa API para pacientes)
    window.showCreateCitaModal = async function() {
        await fetchPatients();
        const patients = patientsCache || [];
        const modalHTML = `
            <div class="modal-backdrop" onclick="event.target === this && window.__agenda.closeModal()">
                <div class="modal">
                    <div class="modern-modal-header"><h3 class="modal-title">Nueva Cita</h3></div>
                    <div class="modern-modal-body">
                        <form id="newCitaForm">
                            <div class="modern-form-group">
                                <label class="modern-label"><span class="label-icon">ğŸ‘¤</span><span>Paciente</span></label>
                                <select name="paciente_id" class="modern-select" required>
                                    <option value="">Seleccionar paciente...</option>
                                    ${patients.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                                </select>
                            </div>
                            <div class="modern-form-group">
                                <label class="modern-label"><span class="label-icon">ğŸ“…</span><span>Fecha</span></label>
                                <input name="fecha" type="date" class="modern-input" value="${new Date().toISOString().slice(0,10)}" required>
                            </div>
                            <div class="modern-form-group">
                                <label class="modern-label"><span class="label-icon">ğŸ•</span><span>Hora</span></label>
                                <input name="hora" type="time" class="modern-input" value="09:00" required>
                            </div>
                            <div class="modern-form-group">
                                <label class="modern-label"><span class="label-icon">ğŸ“Š</span><span>Estado</span></label>
                                <select name="estado" class="modern-select">
                                    <option>Pendiente</option>
                                    <option>Confirmada</option>
                                    <option>Finalizada</option>
                                    <option>Anulada</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modern-modal-footer">
                        <button class="modern-btn cancel-btn" onclick="window.__agenda.closeModal()">Cancelar</button>
                        <button class="modern-btn save-btn" onclick="(async function(){ const form=document.getElementById('newCitaForm'); if(!form.checkValidity()){ form.reportValidity(); return;} const fd=new FormData(form); const payload={ paciente_id: fd.get('paciente_id'), fecha: fd.get('fecha'), hora: fd.get('hora'), estado: fd.get('estado') }; try{ const r=await fetch('/api/citas',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) }); if(!r.ok) throw new Error('create_failed'); }catch(e){ alert('Error creando cita en servidor'); return; } window.__agenda.closeModal(); await renderAppointments(); alert('âœ… Cita creada correctamente'); })()">ğŸ’¾ Guardar</button>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('modalRoot').innerHTML = modalHTML;
    };

    // Inicializar
    document.addEventListener('DOMContentLoaded', async function() {
        await fetchPatients();
        await fetchAppointments();
        renderAppointments();
    });

})();
</script>

</body>
</html>
